<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GAME CENTER - FULL SYSTEM</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00D2BE; --secondary: #FFD93D; --accent: #FF6B6B; --bg: #F0F4F8; --card-bg: #FFFFFF; --text: #2D3436; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Kanit', sans-serif; margin: 0; background: radial-gradient(circle at top right, #E0F7F9, var(--bg)); color: var(--text); height: 100vh; width: 100vw; overflow: hidden; }
        
        /* Animations & Button Effects */
        .btn, .sudoku-cell, #pad button { transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer; }
        .btn:active, #pad button:active { transform: scale(0.92); box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        
        .page-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; align-items: center; justify-content: center; padding: 20px; z-index: 10; }
        .active-layer { display: flex !important; z-index: 100 !important; }
        .card { background: var(--card-bg); padding: 25px; border-radius: 25px; width: 100%; max-width: 440px; box-shadow: 0 15px 35px rgba(0,210,190,0.15); text-align: center; position: relative; max-height: 90vh; overflow-y: auto; }
        
        .btn { display: block; width: 100%; padding: 14px; border-radius: 15px; border: none; font-family: 'Kanit'; font-weight: 600; font-size: 1rem; margin-top: 10px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), #00BFA5); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--accent), #FF5252); color: white; }
        .btn-warning { background: linear-gradient(135deg, #FFD93D, #F6C90E); color: #2D3436; }
        .btn-outline { background: #F1F3F5; color: #4A5568; }
        .btn-sm { padding: 6px 10px; font-size: 0.75rem; width: auto; display: inline-block; margin: 2px; border-radius: 8px; }

        input { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid #EDF2F7; text-align: center; font-family: 'Kanit'; font-size: 1.1rem; margin-bottom: 12px; }
        .hidden { display: none !important; }

        /* Hint & Banned Animations */
        @keyframes bulbGlow { 0% { transform: scale(0.8); opacity: 0.5; filter: drop-shadow(0 0 0px yellow); } 50% { transform: scale(1.1); opacity: 1; filter: drop-shadow(0 0 20px yellow); } 100% { transform: scale(1); opacity: 1; } }
        .hint-icon { font-size: 80px; animation: bulbGlow 0.8s ease-in-out infinite alternate; }
        
        #layer-banned { background: #FF0000 !important; color: white; z-index: 9999 !important; }
        .banned-card { border: 5px solid white; animation: shake 0.3s infinite; }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 100% { transform: translate(1px, -1px) rotate(0deg); } }

        /* Game Elements */
        .sudoku-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 20px 0; background: #EDF2F7; padding: 8px; border-radius: 15px; }
        .sudoku-cell { width: 100%; aspect-ratio: 1; text-align: center; font-size: 1.8rem; border: none; border-radius: 8px; font-weight: bold; color: var(--primary); background: white; }
        .card-24-num { display: inline-block; width: 60px; height: 60px; line-height: 60px; background: #E0F7F9; color: var(--primary); font-size: 2rem; font-weight: 800; border-radius: 15px; margin: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        td, th { padding: 10px; border-bottom: 1px solid #F1F3F5; text-align: center; }
    </style>
</head>
<body>

    <div id="global-admin-btn" style="position:fixed; top:15px; right:15px; z-index:1001; cursor:pointer;" onclick="openAdminAuth()">‚öôÔ∏è</div>

    <div id="layer-welcome" class="page-layer active-layer"><div class="card"><h1>GAME CENTER</h1><button class="btn btn-primary" onclick="changeLayer('layer-intro')">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button></div></div>
    
    <div id="layer-intro" class="page-layer"><div class="card"><h2>üë• ‡∏Ñ‡∏ì‡∏∞‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥</h2><p>1. ‡∏ä‡∏±‡∏¢‡πÄ‡∏°‡∏ò 2. ‡∏ì‡∏±‡∏ê‡∏û‡∏á‡∏©‡πå 3. ‡∏ß‡∏¥‡∏†‡∏≤‡∏î‡∏≤ 4. ‡∏Å‡∏≤‡∏ô‡∏ï‡∏¥‡πå‡∏ä‡∏ô‡∏¥‡∏ï 5. ‡∏ä‡∏ô‡∏¥‡∏™‡∏£‡∏≤</p><button class="btn btn-primary" onclick="changeLayer('layer-lock')">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button></div></div>

    <div id="layer-lock" class="page-layer">
        <div class="card">
            <h2>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h2>
            <div id="lock-content"><input type="text" id="p-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" oninput="checkInputName()"><button id="btn-ready" class="btn btn-primary" onclick="registerPlayer()" disabled>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°</button></div>
            <div id="ready-status" class="hidden"><h3>‚è≥ ‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°...</h3></div>
        </div>
    </div>

    <div id="layer-admin-panel" class="page-layer">
        <div class="card">
            <h3>‚öôÔ∏è Admin Panel</h3>
            <div style="margin-bottom:10px;">
                <button class="btn btn-primary btn-sm" onclick="startGame('MATH')">‡∏™‡∏°‡∏Å‡∏≤‡∏£</button>
                <button class="btn btn-primary btn-sm" onclick="startGame('SUDOKU')">Sudoku</button>
                <button class="btn btn-primary btn-sm" onclick="startGame('GAME24')">Game 24</button>
            </div>
            <button class="btn btn-outline" onclick="loadBanList(); changeLayer('layer-ban-list')">üö´ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ô/‡∏™‡πà‡∏á‡πÄ‡∏â‡∏•‡∏¢</button>
            <button class="btn btn-outline" onclick="changeLayer('layer-scoreboard')">üèÜ ‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
            <button class="btn btn-outline" onclick="changeLayer('layer-lock')">‡∏Å‡∏•‡∏±‡∏ö</button>
        </div>
    </div>

    <div id="layer-ban-list" class="page-layer">
        <div class="card"><h3>üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h3><div id="ban-table-body" style="max-height:300px; overflow-y:auto; text-align:left;"></div><button class="btn btn-outline" onclick="changeLayer('layer-admin-panel')">‡∏Å‡∏•‡∏±‡∏ö</button></div>
    </div>

    <div id="layer-scoreboard" class="page-layer">
        <div class="card"><h2>üèÜ Top 5 Leaderboard</h2><table id="score-table-body"></table><div id="admin-only-back" class="hidden"><button class="btn btn-outline" onclick="changeLayer('layer-admin-panel')">‡∏Å‡∏•‡∏±‡∏ö</button></div><p style="font-size:0.8rem; color:#A0AEC0; margin-top:15px;">‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠</p></div>
    </div>

    <div id="layer-banned" class="page-layer">
        <div class="card banned-card">
            <h1 style="color:red; font-size:3.5rem;">‚õî</h1>
            <h2 style="color:red;">‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°</h2>
            <p style="color:black;"><b>‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤</b></p>
        </div>
    </div>

    <div id="layer-hint" class="page-layer" style="background:rgba(255,255,255,0.9);">
        <div class="card">
            <div class="hint-icon">üí°</div>
            <h2>‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤</h2>
            <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ...</p>
        </div>
    </div>

    <div id="layer-unlocking" class="page-layer" style="background:var(--primary); color:white;">
        <div style="font-size:100px; animation: bulbGlow 1s ease-out;">üîì</div>
    </div>

    <div id="layer-deleted" class="page-layer" style="background:black; color:white;"><h1>üëã ‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á</h1><button class="btn btn-primary" onclick="location.reload()">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</button></div>
    
    <div id="layer-countdown" class="page-layer" style="background:white;"><div class="card"><h2>READY...</h2><div id="cd-number" style="font-size:5rem; color:var(--primary);">5</div></div></div>
    <div id="layer-game-math" class="page-layer"><div class="card"><h3>üßÆ ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏°‡∏Å‡∏≤‡∏£</h3><div id="math-questions">1. 2x+3=11 | 2. x-5=2 | 3. 3(x-1)=12 | 4. 10-x=4</div><div id="math-display" style="font-size:2rem; margin:20px; color:var(--primary);">_ _ _ _</div><button class="btn btn-primary" onclick="checkMathHand()">‡∏ï‡∏Å‡∏•‡∏á</button></div></div>
    <div id="layer-game-sudoku" class="page-layer"><div class="card"><h3>üß© SUDOKU</h3><div id="sudoku-container" class="sudoku-grid"></div><button class="btn btn-primary" onclick="finishGame()">‡∏™‡πà‡∏á</button></div></div>
    <div id="layer-game-24" class="page-layer"><div class="card"><h3>üßÆ GAME 24</h3><div id="game-24-display"></div><input type="text" id="game-24-input"><button class="btn btn-warning" onclick="finishGame()">‡∏ï‡∏£‡∏ß‡∏à</button></div></div>

    <div id="layer-admin-auth" class="page-layer" style="background:rgba(0,0,0,0.8);"><div class="card"><h3>Admin Access</h3><input type="password" id="admin-pass-input"><button class="btn btn-primary" onclick="checkAdminPass()">Login</button></div></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDJf-qOOB_hmP1higooEpMSFe2768dMxfE", databaseURL: "https://mathpasswordgame2-default-rtdb.asia-southeast1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myName = "", currentLayer = "layer-welcome", isBanned = false, gameStartTime = 0;
        let scoreInterval = null;

        function changeLayer(id) {
            if(['layer-banned', 'layer-hint', 'layer-unlocking'].includes(id)) {
                document.querySelectorAll('.page-layer').forEach(l => l.classList.remove('active-layer'));
                document.getElementById(id).classList.add('active-layer');
                return;
            }
            currentLayer = id;
            document.querySelectorAll('.page-layer').forEach(l => l.classList.remove('active-layer'));
            document.getElementById(id).classList.add('active-layer');
            
            if(id === 'layer-scoreboard') {
                if(!scoreInterval) scoreInterval = setInterval(updateLeaderboard, 1000);
                document.getElementById('admin-only-back').className = (myName === 'admin') ? '' : 'hidden';
            } else { clearInterval(scoreInterval); scoreInterval = null; }
        }

        function playBannedSound() {
            try {
                const context = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = context.createOscillator();
                const gain = context.createGain();
                oscillator.type = 'square'; oscillator.frequency.setValueAtTime(900, context.currentTime);
                oscillator.connect(gain); gain.connect(context.destination);
                oscillator.start(); gain.gain.exponentialRampToValueAtTime(0.0001, context.currentTime + 5);
                setTimeout(() => oscillator.stop(), 5000);
            } catch(e) {}
        }

        function registerPlayer() {
            myName = document.getElementById('p-name').value.trim();
            db.ref('players/' + myName).update({ name: myName, status: 'ready', banned: false, hint_trigger: 0 });
            
            db.ref('players/' + myName).on('value', s => {
                const p = s.val(); if(!p) { changeLayer('layer-deleted'); return; }

                // Check Ban Status
                if(p.banned && !isBanned) { isBanned = true; playBannedSound(); changeLayer('layer-banned'); }
                else if(!p.banned && isBanned) { 
                    isBanned = false; changeLayer('layer-unlocking'); 
                    setTimeout(() => changeLayer(currentLayer), 1500); 
                }

                // Check Hint Trigger
                if(p.hint_trigger && (Date.now() - p.hint_trigger < 3000)) {
                    db.ref('players/' + myName).update({ hint_trigger: 0 });
                    changeLayer('layer-hint');
                    setTimeout(finishGame, 2000);
                }

                if(p.status === 'finished' && currentLayer !== 'layer-scoreboard') changeLayer('layer-scoreboard');
                if(p.status === 'playing' && currentLayer === 'layer-scoreboard') changeLayer('layer-lock'); // Reset if new game starts
            });
            document.getElementById('lock-content').classList.add('hidden');
            document.getElementById('ready-status').classList.remove('hidden');
        }

        // --- Admin Functions ---
        function loadBanList() {
            db.ref('players').on('value', s => {
                const con = document.getElementById('ban-table-body'); con.innerHTML = "";
                s.forEach(c => {
                    if(c.key === 'admin') return;
                    const p = c.val();
                    con.innerHTML += `<div style="display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid #eee;">
                        <span style="font-weight:bold;">${p.name}</span>
                        <div>
                            <button class="btn-sm btn-warning" onclick="sendHint('${p.name}')">‚ö° ‡πÄ‡∏â‡∏•‡∏¢</button>
                            <button class="btn-sm" style="color:${p.banned?'green':'red'}" onclick="toggleBan('${p.name}', ${p.banned})">${p.banned?'‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô':'‡πÅ‡∏ö‡∏ô'}</button>
                            <button class="btn-sm" style="background:black; color:white;" onclick="deletePlayer('${p.name}')">‡∏•‡∏ö</button>
                        </div>
                    </div>`;
                });
            });
        }
        function toggleBan(t, s) { db.ref('players/' + t).update({ banned: !s }); }
        function deletePlayer(t) { if(confirm('‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô '+t+'?')) db.ref('players/'+t).remove(); }
        function sendHint(t) { db.ref('players/' + t).update({ hint_trigger: Date.now() }); }

        // --- Game System ---
        function startGame(type) { 
            db.ref('players').once('value', s => {
                s.forEach(c => { if(c.key !== 'admin') db.ref('players/'+c.key).update({status:'ready', finishTime:0, startTime:0}); });
            });
            db.ref('system/game_state').set({ type, state: 'COUNTDOWN', ts: Date.now() }); 
        }

        db.ref('system/game_state').on('value', s => {
            const d = s.val(); if(!d || !myName || Date.now()-d.ts > 10000) return;
            if(d.state === 'COUNTDOWN') {
                changeLayer('layer-countdown'); let c=5;
                let t = setInterval(() => {
                    c--; document.getElementById('cd-number').innerText=c;
                    if(c<=0) { 
                        clearInterval(t); gameStartTime = Date.now();
                        if(myName !== 'admin') db.ref('players/'+myName).update({startTime: gameStartTime, status: 'playing'});
                        changeLayer(d.type === 'MATH' ? 'layer-game-math' : (d.type === 'SUDOKU' ? 'layer-game-sudoku' : 'layer-game-24'));
                    }
                }, 1000);
            }
        });

        function checkMathHand() { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏ô‡πÄ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡πÄ‡∏â‡∏•‡∏¢‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô"); }
        function finishGame() { db.ref('players/'+myName).update({finishTime: Date.now(), status: 'finished'}); changeLayer('layer-scoreboard'); }

        function updateLeaderboard() {
            db.ref('players').once('value', s => {
                let pList = [];
                s.forEach(c => { if(c.key !== 'admin' && c.val().finishTime) pList.push({name: c.key, time: (c.val().finishTime - c.val().startTime)/1000}); });
                pList.sort((a,b) => a.time - b.time);
                let h = `<tr><th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th></tr>`;
                pList.slice(0,5).forEach((p, i) => h += `<tr><td>${i+1}</td><td><b>${p.name}</b></td><td style="color:red">${p.time.toFixed(2)}s</td></tr>`);
                document.getElementById('score-table-body').innerHTML = h || "<tr><td colspan='3'>‡∏£‡∏≠‡∏ô‡∏±‡∏Å‡πÅ‡∏Ç‡πà‡∏á‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô...</td></tr>";
            });
        }

        function openAdminAuth() { changeLayer('layer-admin-auth'); }
        function checkAdminPass() { if(document.getElementById('admin-pass-input').value === "182137") { myName="admin"; changeLayer('layer-admin-panel'); } }
        function checkInputName() { document.getElementById('btn-ready').disabled = document.getElementById('p-name').value.length < 2; }
    </script>
</body>
</html>
