<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MATH CODE M.1 - INFINITE EDITION</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00D2BE; --bg: #F0F4F8; --card-bg: #FFFFFF; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Kanit', sans-serif; margin: 0; background: var(--bg); height: 100vh; overflow: hidden; }
        
        .btn, .key, .admin-gear { transition: transform 0.1s; cursor: pointer; border: none; border-radius: 20px; }
        .btn:active, .key:active, .admin-gear:active { transform: scale(0.92); }
        
        input { width: 100%; padding: 18px; border-radius: 30px; border: 2px solid #E2E8F0; text-align: center; font-family: 'Kanit'; margin-bottom: 20px; font-size: 1.1rem; }

        .page-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; align-items: center; justify-content: center; padding: 20px; z-index: 10; }
        .active-layer { display: flex !important; z-index: 100 !important; }
        .card { background: var(--card-bg); padding: 30px; border-radius: 40px; width: 100%; max-width: 420px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); text-align: center; position: relative; }
        
        .btn-primary { background: linear-gradient(135deg, var(--primary), #00BFA5); color: white; padding: 15px; width: 100%; font-weight: 600; margin-top: 10px; font-size: 1.1rem; }
        .admin-gear { position: fixed; top: 20px; right: 20px; background: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 1001; }

        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .key { background: #F8FAFC; padding: 18px; font-size: 1.5rem; font-weight: 600; box-shadow: 0 4px 0 #CBD5E1; }
        
        .feedback-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 40px; display: none; align-items: center; justify-content: center; font-size: 6rem; z-index: 110; background: rgba(255,255,255,0.9); }
        
        #layer-banned { background: #FF0000 !important; z-index: 9999 !important; }
        .shake { animation: shake 0.3s infinite; }
        @keyframes shake { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(-2px,2px); } 75% { transform: translate(2px,-2px); } }
    </style>
</head>
<body>

    <div class="admin-gear" onclick="openAdminAuth()">‚öôÔ∏è</div>

    <div id="layer-welcome" class="page-layer active-layer">
        <div class="card">
            <h1 style="color:var(--primary)">MATH CODE M.1</h1>
            <div style="text-align:left; font-size:0.85rem; background:#F8FAFC; padding:15px; border-radius:25px; margin-bottom:20px; line-height:1.6;">
                <b>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥:</b> ‡∏ä‡∏±‡∏¢‡πÄ‡∏°‡∏ò (2), ‡∏ì‡∏±‡∏ê‡∏û‡∏á‡∏©‡πå (3), ‡∏Å‡∏≤‡∏ô‡∏ï‡∏¥‡πå‡∏ä‡∏ô‡∏¥‡∏ï (14), ‡∏ä‡∏ô‡∏¥‡∏™‡∏£‡∏≤ (15), ‡∏ß‡∏¥‡∏†‡∏≤‡∏î‡∏≤ (26)
            </div>
            <button class="btn btn-primary" onclick="changeLayer('layer-lock')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏™‡∏ô‡∏≤‡∏°‡∏™‡∏≠‡∏ö</button>
        </div>
    </div>

    <div id="layer-lock" class="page-layer">
        <div class="card"><h2>‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2><input type="text" id="p-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô"><button class="btn btn-primary" onclick="registerPlayer()">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß!</button></div>
    </div>

    <div id="layer-lobby" class="page-layer">
        <div class="card"><h3>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÇ‡∏à‡∏ó‡∏¢‡πå...</h3><div id="lobby-list" style="margin: 20px 0;"></div></div>
    </div>

    <div id="layer-countdown" class="page-layer" style="background:white;"><div style="font-size:10rem; color:var(--primary); font-weight:800;" id="cd-text">5</div></div>

    <div id="layer-game-math" class="page-layer">
        <div class="card">
            <div id="feedback-correct" class="feedback-overlay" style="color:#00D2BE;">‚úÖ</div>
            <div id="feedback-wrong" class="feedback-overlay" style="color:#FF6B6B;">‚ùå</div>
            <div id="quest-area" style="background:#F0FDFA; padding:15px; border-radius:25px; border:2px dashed var(--primary); margin-bottom:10px; font-size: 1.1rem; text-align: left;"></div>
            <div id="code-display" style="font-size:3rem; color:var(--primary); font-weight:800; letter-spacing:10px;">____</div>
            <div class="keypad">
                <button class="key" onclick="press('1')">1</button><button class="key" onclick="press('2')">2</button><button class="key" onclick="press('3')">3</button>
                <button class="key" onclick="press('4')">4</button><button class="key" onclick="press('5')">5</button><button class="key" onclick="press('6')">6</button>
                <button class="key" onclick="press('7')">7</button><button class="key" onclick="press('8')">8</button><button class="key" onclick="press('9')">9</button>
                <button class="key" style="background:#FFE4E6; color:#E11D48;" onclick="press('DEL')">‚å´</button><button class="key" onclick="press('0')">0</button><button class="key" style="background:var(--primary); color:white;" onclick="checkAns()">‡∏ï‡∏Å‡∏•‡∏á</button>
            </div>
        </div>
    </div>

    <div id="layer-admin" class="page-layer"><div class="card"><h2>‚öôÔ∏è Admin Control</h2><button class="btn btn-primary" onclick="adminTrigger()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á</button><button class="btn btn-primary" style="background:black" onclick="loadAdminManage()">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ & ‡πÅ‡∏ö‡∏ô & ‡πÄ‡∏â‡∏•‡∏¢</button><button class="btn btn-primary" style="background:gray" onclick="changeLayer('layer-welcome')">‡∏≠‡∏≠‡∏Å</button></div></div>
    <div id="layer-manage" class="page-layer"><div class="card"><div id="admin-notif" class="feedback-overlay"></div><h3>üë• ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h3><div id="manage-box" style="text-align:left; max-height:300px; overflow-y:auto;"></div><button class="btn btn-primary" onclick="changeLayer('layer-admin')">‡∏Å‡∏•‡∏±‡∏ö</button></div></div>
    <div id="layer-scoreboard" class="page-layer"><div class="card"><h2>üèÜ ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2><div id="score-box"></div><button class="btn btn-primary" onclick="location.reload()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button></div></div>
    <div id="layer-banned" class="page-layer"><div class="card shake" style="border:5px solid white;"><h1 style="color:red; font-size:5rem;">‚õî</h1><h2>‡∏ñ‡∏π‡∏Å‡πÅ‡∏ö‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á</h2></div></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDJf-qOOB_hmP1higooEpMSFe2768dMxfE", databaseURL: "https://mathpasswordgame2-default-rtdb.asia-southeast1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myName = "", currentCode = "", targetAns = "", isBanned = false, gameRun = false;

        function changeLayer(id) {
            document.querySelectorAll('.page-layer').forEach(l => l.classList.remove('active-layer'));
            document.getElementById(id).classList.add('active-layer');
        }

        const audio = {
            whistle: () => { let c=new AudioContext(); let o=c.createOscillator(); o.frequency.setValueAtTime(1500,c.currentTime); o.connect(c.destination); o.start(); o.stop(c.currentTime+0.4); },
            wrong: () => { let c=new AudioContext(); let o=c.createOscillator(); o.type='sawtooth'; o.frequency.setValueAtTime(120,c.currentTime); o.connect(c.destination); o.start(); o.stop(c.currentTime+0.3); }
        };

        function registerPlayer() {
            myName = document.getElementById('p-name').value.trim();
            if(!myName) return;
            db.ref('players/'+myName).set({ name: myName, status: 'ready', banned: false, hint: false });
            changeLayer('layer-lobby');
            setInterval(updateLobby, 1000);
            
            db.ref('players/'+myName).on('value', s => {
                const p = s.val(); if(!p) return;
                if(p.banned && !isBanned) { isBanned=true; changeLayer('layer-banned'); }
                else if(!p.banned && isBanned) { isBanned=false; changeLayer('layer-lobby'); }
                if(p.status === 'countdown' && !gameRun) { gameRun=true; startCountdown(); }
                if(p.hint) {
                    db.ref('players/'+myName).update({hint: false, status: 'finished', finishTime: Date.now(), startTime: Date.now()-5000});
                    changeLayer('layer-scoreboard'); updateScores();
                }
            });
        }

        function startCountdown() {
            changeLayer('layer-countdown');
            let c = 5;
            let i = setInterval(() => {
                c--; document.getElementById('cd-text').innerText = c;
                if(c <= 0) { clearInterval(i); audio.whistle(); generateM1Equations(); changeLayer('layer-game-math'); db.ref('players/'+myName).update({startTime: Date.now(), status: 'playing'}); }
            }, 1000);
        }

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡∏™‡∏°‡∏Å‡∏≤‡∏£ ‡∏°.1 ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô (Infinite) ---
        function generateM1Equations() {
            let res = ""; let html = "";
            const vars = ['a','b','c','d'];
            vars.forEach(v => {
                const answer = Math.floor(Math.random()*10); // 0-9
                res += answer;
                
                // ‡∏™‡∏∏‡πà‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡∏°‡∏Å‡∏≤‡∏£ ‡∏°.1 (3 ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å)
                const type = Math.floor(Math.random()*3);
                let eq = "";
                if(type === 0) { // ax + b = c
                    let a = Math.floor(Math.random()*5)+2;
                    let b = Math.floor(Math.random()*20)+1;
                    eq = `${a}${v} + ${b} = ${a*answer+b}`;
                } else if(type === 1) { // ax - b = c
                    let a = Math.floor(Math.random()*5)+2;
                    let b = Math.floor(Math.random()*15)+1;
                    eq = `${a}${v} - ${b} = ${a*answer-b}`;
                } else { // x/a + b = c
                    let a = Math.floor(Math.random()*3)+2;
                    let b = Math.floor(Math.random()*10)+1;
                    eq = `${v}/${a} + ${b} = ${answer/a+b}`;
                }
                html += `<div style="margin-bottom:5px;"><b>‡∏™‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${v.toUpperCase()}:</b> ${eq}</div>`;
            });
            targetAns = res;
            document.getElementById('quest-area').innerHTML = html + "<center><small>‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡πà‡∏≤ a b c d ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</small></center>";
        }

        function press(k) {
            if(k==='DEL') currentCode = currentCode.slice(0,-1);
            else if(currentCode.length < 4) currentCode += k;
            document.getElementById('code-display').innerText = currentCode.padEnd(4, '_');
        }

        function checkAns() {
            if(currentCode === targetAns) {
                document.getElementById('feedback-correct').style.display='flex';
                setTimeout(() => { db.ref('players/'+myName).update({status:'finished', finishTime: Date.now()}); updateScores(); changeLayer('layer-scoreboard'); }, 1000);
            } else {
                audio.wrong();
                document.getElementById('feedback-wrong').style.display='flex';
                setTimeout(() => { document.getElementById('feedback-wrong').style.display='none'; currentCode=""; press(''); }, 1000);
            }
        }

        function adminTrigger() {
            db.ref('players').once('value', s => { s.forEach(c => { if(c.key!=='admin') db.ref('players/'+c.key).update({status:'countdown'}); }); });
        }

        function loadAdminManage() {
            changeLayer('layer-manage');
            db.ref('players').on('value', s => {
                let h = "";
                s.forEach(c => {
                    if(c.key === 'admin') return;
                    let p = c.val();
                    h += `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #eee; padding:5px;">
                        <span>${p.name}</span>
                        <div>
                            <button onclick="giveHint('${p.name}', '${p.status}')" style="background:#FFD93D; padding:8px; border-radius:10px;">‚ö°</button>
                            <button onclick="db.ref('players/${p.name}').update({banned:${!p.banned}})" style="background:${p.banned?'#00D2BE':'#FF6B6B'}; color:white; padding:8px; border-radius:10px; margin-left:5px;">${p.banned?'‡∏õ‡∏•‡∏î':'‡πÅ‡∏ö‡∏ô'}</button>
                        </div>
                    </div>`;
                });
                document.getElementById('manage-box').innerHTML = h;
            });
        }

        function giveHint(name, status) {
            const fb = document.getElementById('admin-notif');
            if(status === 'playing') {
                db.ref('players/'+name).update({hint: true});
                fb.innerHTML = "‚úÖ"; fb.style.display = "flex"; fb.style.color = "green";
            } else {
                fb.innerHTML = "‚ùå"; fb.style.display = "flex"; fb.style.color = "red";
            }
            setTimeout(() => fb.style.display = "none", 1000);
        }

        function updateLobby() {
            db.ref('players').once('value', s => {
                let h = ""; s.forEach(c => { if(c.key!=='admin') h+=`<div>‚óè ${c.val().name}</div>`; });
                document.getElementById('lobby-list').innerHTML = h;
            });
        }

        function updateScores() {
            db.ref('players').once('value', s => {
                let list = []; s.forEach(c => { if(c.val().finishTime) list.push(c.val()); });
                list.sort((a,b) => (a.finishTime-a.startTime) - (b.finishTime-b.startTime));
                let h = ""; list.forEach((p,i) => h += `<div style="padding:10px; border-bottom:1px solid #eee;">${i+1}. ${p.name} - ${((p.finishTime-p.startTime)/1000).toFixed(2)}s</div>`);
                document.getElementById('score-box').innerHTML = h;
            });
        }

        function openAdminAuth() { if(prompt("‡∏£‡∏´‡∏±‡∏™:") === "182137") { myName="admin"; changeLayer('layer-admin'); } }
    </script>
</body>
</html>
