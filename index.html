<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GAME CENTER - FULL SYSTEM</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00D2BE; --secondary: #FFD93D; --accent: #FF6B6B; --bg: #F0F4F8; --card-bg: #FFFFFF; --text: #2D3436; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Kanit', sans-serif; margin: 0; background: var(--bg); color: var(--text); height: 100vh; width: 100vw; overflow: hidden; }
        
        .page-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; align-items: center; justify-content: center; padding: 20px; z-index: 10; transition: background 0.5s; }
        .active-layer { display: flex !important; z-index: 100 !important; }
        .card { background: var(--card-bg); padding: 25px; border-radius: 25px; width: 100%; max-width: 440px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); text-align: center; position: relative; }
        
        .btn { display: block; width: 100%; padding: 14px; border-radius: 15px; border: none; font-family: 'Kanit'; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--accent); color: white; }
        .btn-outline { background: #F1F3F5; color: #4A5568; }
        .btn-sm { padding: 6px 10px; font-size: 0.75rem; width: auto; display: inline-block; margin: 2px; border-radius: 8px; }

        input { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid #EDF2F7; text-align: center; font-family: 'Kanit'; margin-bottom: 12px; }
        .hidden { display: none !important; }
        
        /* Banned & Unlock Animation */
        #layer-banned { background: #FF0000; color: white; z-index: 9999 !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        .banned-box { animation: shake 0.2s infinite; }
        
        #layer-unlocking { background: #00D2BE; color: white; z-index: 10000 !important; }
        @keyframes unlockAnim { 
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.5) rotate(-20deg); opacity: 1; }
            100% { transform: scale(5); opacity: 0; }
        }
        .unlock-icon { font-size: 100px; animation: unlockAnim 1.5s forwards; }

        /* Scoreboard */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        td, th { padding: 10px; border-bottom: 1px solid #F1F3F5; text-align: center; }
        .rank-badge { background: var(--secondary); padding: 2px 8px; border-radius: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="global-admin-btn" style="position:fixed; top:15px; right:15px; z-index:1001; cursor:pointer;" onclick="openAdminAuth()">‚öôÔ∏è</div>

    <div id="layer-welcome" class="page-layer active-layer"><div class="card"><h1>GAME CENTER</h1><button class="btn btn-primary" onclick="changeLayer('layer-intro')">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button></div></div>
    
    <div id="layer-intro" class="page-layer"><div class="card"><h2>üë• ‡∏Ñ‡∏ì‡∏∞‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥</h2><p>1. ‡∏ä‡∏±‡∏¢‡πÄ‡∏°‡∏ò 2. ‡∏ì‡∏±‡∏ê‡∏û‡∏á‡∏©‡πå 3. ‡∏ß‡∏¥‡∏†‡∏≤‡∏î‡∏≤ 4. ‡∏Å‡∏≤‡∏ô‡∏ï‡∏¥‡πå‡∏ä‡∏ô‡∏¥‡∏ï 5. ‡∏ä‡∏ô‡∏¥‡∏™‡∏£‡∏≤</p><button class="btn btn-primary" onclick="changeLayer('layer-lock')">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button></div></div>

    <div id="layer-lock" class="page-layer">
        <div class="card">
            <h2>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h2>
            <div id="lock-content"><input type="text" id="p-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô" oninput="checkInputName()"><button id="btn-ready" class="btn btn-primary" onclick="registerPlayer()" disabled>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°</button></div>
            <div id="ready-status" class="hidden"><h3>‚è≥ ‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°...</h3></div>
        </div>
    </div>

    <div id="layer-admin-panel" class="page-layer">
        <div class="card">
            <h3>‚öôÔ∏è Admin Panel</h3>
            <button class="btn btn-primary" onclick="startGame('MATH')">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏™‡∏°‡∏Å‡∏≤‡∏£</button>
            <button class="btn btn-outline" onclick="loadBanList(); changeLayer('layer-ban-list')">üö´ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button>
            <button class="btn btn-outline" onclick="changeLayer('layer-scoreboard')">üèÜ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
            <button class="btn btn-outline" onclick="changeLayer('layer-lock')">‡∏Å‡∏•‡∏±‡∏ö</button>
        </div>
    </div>

    <div id="layer-ban-list" class="page-layer">
        <div class="card"><h3>üö´ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ô</h3><div id="ban-table-body" style="max-height:300px; overflow-y:auto;"></div><button class="btn btn-outline" onclick="changeLayer('layer-admin-panel')">‡∏Å‡∏•‡∏±‡∏ö</button></div>
    </div>

    <div id="layer-scoreboard" class="page-layer">
        <div class="card"><h2>üèÜ Top 5</h2><table id="score-table-body"></table><div id="admin-only-back" class="hidden"><button class="btn btn-outline" onclick="changeLayer('layer-admin-panel')">‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</button></div></div>
    </div>

    <div id="layer-banned" class="page-layer">
        <div class="card banned-box" style="background:white; color:black; border: 5px solid red;">
            <h1 style="color:red; font-size:3rem;">‚õî</h1>
            <h2 style="color:red;">‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
            <p><b>‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°<br>‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤</b></p>
        </div>
    </div>

    <div id="layer-unlocking" class="page-layer">
        <div class="unlock-icon">üîì</div>
    </div>

    <div id="layer-admin-auth" class="page-layer" style="background:rgba(0,0,0,0.8);"><div class="card"><h3>Admin Access</h3><input type="password" id="admin-pass-input"><button class="btn btn-primary" onclick="checkAdminPass()">Login</button></div></div>
    <div id="layer-countdown" class="page-layer" style="background:white;"><div class="card"><h2>READY...</h2><div id="cd-number" style="font-size:5rem; color:var(--primary);">5</div></div></div>
    <div id="layer-game-math" class="page-layer"><div class="card"><h3>üßÆ ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</h3><div id="math-display" style="font-size:2rem; margin:20px;">_ _ _ _</div><button class="btn btn-primary" onclick="finishGame()">‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏ä‡∏ô‡∏∞</button></div></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDJf-qOOB_hmP1higooEpMSFe2768dMxfE", databaseURL: "https://mathpasswordgame2-default-rtdb.asia-southeast1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myName = "", currentLayer = "layer-welcome", isBanned = false;
        let scoreInterval = null;

        function changeLayer(id) {
            if(id === 'layer-banned' || id === 'layer-unlocking') {
                document.querySelectorAll('.page-layer').forEach(l => l.classList.remove('active-layer'));
                document.getElementById(id).classList.add('active-layer');
                return;
            }
            currentLayer = id; 
            document.querySelectorAll('.page-layer').forEach(l => l.classList.remove('active-layer'));
            document.getElementById(id).classList.add('active-layer');
            
            if(id === 'layer-scoreboard') {
                if(!scoreInterval) scoreInterval = setInterval(updateLeaderboard, 1000);
                document.getElementById('admin-only-back').className = (myName === 'admin') ? '' : 'hidden';
            } else {
                clearInterval(scoreInterval); scoreInterval = null;
            }
        }

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á Beep (Cell Broadcast Style) ---
        function playBannedSound() {
            const context = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = context.createOscillator();
            const gainNode = context.createGain();
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(880, context.currentTime); // High pitch
            oscillator.connect(gainNode);
            gainNode.connect(context.destination);
            oscillator.start();
            gainNode.gain.exponentialRampToValueAtTime(0.00001, context.currentTime + 5);
            setTimeout(() => oscillator.stop(), 5000);
        }

        function registerPlayer() {
            myName = document.getElementById('p-name').value.trim();
            db.ref('players/' + myName).update({ name: myName, status: 'ready', banned: false });
            
            db.ref('players/' + myName).on('value', s => {
                const p = s.val();
                if(!p) return;

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÇ‡∏î‡∏ô‡πÅ‡∏ö‡∏ô
                if(p.banned && !isBanned) {
                    isBanned = true;
                    playBannedSound();
                    changeLayer('layer-banned');
                } 
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô
                else if(!p.banned && isBanned) {
                    isBanned = false;
                    changeLayer('layer-unlocking');
                    setTimeout(() => {
                        changeLayer(currentLayer); // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
                    }, 1500);
                }

                if(p.status === 'finished' && currentLayer !== 'layer-scoreboard') changeLayer('layer-scoreboard');
            });
            document.getElementById('lock-content').classList.add('hidden');
            document.getElementById('ready-status').classList.remove('hidden');
        }

        // --- Admin Controls ---
        function loadBanList() {
            db.ref('players').on('value', s => {
                const con = document.getElementById('ban-table-body'); con.innerHTML = "";
                s.forEach(c => {
                    if(c.key === 'admin') return;
                    const p = c.val();
                    con.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
                        <span>${p.name} ${p.banned ? 'üî¥' : 'üü¢'}</span>
                        <button class="btn-sm ${p.banned?'btn-primary':'btn-danger'}" onclick="toggleBan('${p.name}', ${p.banned})">
                            ${p.banned ? '‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô' : '‡πÅ‡∏ö‡∏ô'}
                        </button>
                    </div>`;
                });
            });
        }

        function toggleBan(target, currentStatus) {
            db.ref('players/' + target).update({ banned: !currentStatus });
        }

        function openAdminAuth() { changeLayer('layer-admin-auth'); }
        function checkAdminPass() { if(document.getElementById('admin-pass-input').value === "182137") { myName="admin"; changeLayer('layer-admin-panel'); } }
        function checkInputName() { document.getElementById('btn-ready').disabled = document.getElementById('p-name').value.length < 2; }
        
        // --- Game System (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
        function startGame(type) { db.ref('system/game_state').set({ type, state: 'COUNTDOWN', ts: Date.now() }); }
        db.ref('system/game_state').on('value', s => {
            const d = s.val(); if(!d || !myName || Date.now()-d.ts > 10000) return;
            if(d.state === 'COUNTDOWN') {
                changeLayer('layer-countdown'); let c=5;
                let t = setInterval(() => {
                    c--; document.getElementById('cd-number').innerText=c;
                    if(c<=0) { clearInterval(t); if(myName !== 'admin') db.ref('players/'+myName).update({startTime: Date.now(), status: 'playing'}); changeLayer('layer-game-math'); }
                }, 1000);
            }
        });

        function finishGame() { db.ref('players/'+myName).update({finishTime: Date.now(), status: 'finished'}); changeLayer('layer-scoreboard'); }

        function updateLeaderboard() {
            db.ref('players').once('value', s => {
                let pList = [];
                s.forEach(c => { if(c.key !== 'admin' && c.val().finishTime) pList.push({name: c.key, time: (c.val().finishTime - c.val().startTime)/1000}); });
                pList.sort((a,b) => a.time - b.time);
                let h = `<tr><th>#</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th></tr>`;
                pList.slice(0,5).forEach((p, i) => h += `<tr><td><span class="rank-badge">${i+1}</span></td><td>${p.name}</td><td>${p.time.toFixed(2)}s</td></tr>`);
                document.getElementById('score-table-body').innerHTML = h;
            });
        }
    </script>
</body>
</html>
