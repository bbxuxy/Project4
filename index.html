<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GAME CENTER - FULL SYSTEM</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00D2BE; --secondary: #FFD93D; --accent: #FF6B6B; --bg: #F0F4F8; --card-bg: #FFFFFF; --text: #2D3436; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Kanit', sans-serif; margin: 0; background: radial-gradient(circle at top right, #E0F7F9, var(--bg)); color: var(--text); height: 100vh; width: 100vw; overflow: hidden; }
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∏‡∏ö (Button Active Effect) */
        .btn, .sudoku-cell, #pad button, .btn-sm { transition: all 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer; }
        .btn:active, .btn-sm:active, #pad button:active { transform: scale(0.94); filter: brightness(0.9); }
        
        .page-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; align-items: center; justify-content: center; padding: 20px; z-index: 10; }
        .active-layer { display: flex !important; z-index: 100 !important; }
        .card { background: var(--card-bg); padding: 25px; border-radius: 25px; width: 100%; max-width: 440px; box-shadow: 0 15px 35px rgba(0,210,190,0.15); text-align: center; position: relative; max-height: 90vh; overflow-y: auto; }
        
        .btn { display: block; width: 100%; padding: 14px; border-radius: 15px; border: none; font-family: 'Kanit'; font-weight: 600; font-size: 1rem; margin-top: 10px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), #00BFA5); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--accent), #FF5252); color: white; }
        .btn-warning { background: linear-gradient(135deg, #FFD93D, #F6C90E); color: #2D3436; }
        .btn-outline { background: #F1F3F5; color: #4A5568; }
        .btn-sm { padding: 8px 12px; font-size: 0.75rem; border-radius: 8px; border: none; font-family: 'Kanit'; font-weight: 500; }

        input { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid #EDF2F7; text-align: center; font-family: 'Kanit'; font-size: 1.1rem; margin-bottom: 12px; }

        /* Animation: ‡∏´‡∏•‡∏≠‡∏î‡πÑ‡∏ü (Hint) */
        @keyframes bulbGlow { 0% { transform: scale(0.9); filter: drop-shadow(0 0 5px #FFD93D); } 100% { transform: scale(1.1); filter: drop-shadow(0 0 30px #FFD93D); } }
        .hint-icon { font-size: 80px; animation: bulbGlow 0.6s ease-in-out infinite alternate; }
        
        /* Animation: ‡∏™‡∏±‡πà‡∏ô (Banned) */
        @keyframes shake { 0%, 100% { transform: translate(0,0); } 10%, 30%, 50%, 70%, 90% { transform: translate(-5px,0); } 20%, 40%, 60%, 80% { transform: translate(5px,0); } }
        .banned-active { animation: shake 0.4s infinite; border: 4px solid red !important; }

        /* Animation: ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ */
        @keyframes unlockScale { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(5); opacity: 0; } }
        .unlock-symbol { font-size: 100px; animation: unlockScale 1.2s forwards; color: white; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        td, th { padding: 12px; border-bottom: 1px solid #F1F3F5; text-align: center; }
        .rank-badge { background: var(--secondary); padding: 2px 8px; border-radius: 8px; font-weight: 800; }
    </style>
</head>
<body>

    <div id="global-admin-btn" style="position:fixed; top:15px; right:15px; z-index:1001; font-size:24px; cursor:pointer;" onclick="openAdminAuth()">‚öôÔ∏è</div>

    <div id="layer-welcome" class="page-layer active-layer"><div class="card"><h1 style="color:var(--primary); font-size: 3rem;">GAME CENTER</h1><button class="btn btn-primary" onclick="changeLayer('layer-intro')">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button></div></div>
    
    <div id="layer-intro" class="page-layer">
        <div class="card">
            <h2 style="color:var(--primary);">üë• ‡∏Ñ‡∏ì‡∏∞‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥</h2>
            <div style="text-align:left; font-size:0.95rem; background:#F8FAFC; padding:20px; border-radius:20px; line-height:1.8;">
                <b>1. ‡∏î.‡∏ä.‡∏ä‡∏±‡∏¢‡πÄ‡∏°‡∏ò ‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏≠‡∏°‡∏£‡πÄ‡∏ß‡∏ä</b> ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 2<br>
                <b>2. ‡∏î.‡∏ä.‡∏ì‡∏±‡∏ê‡∏û‡∏á‡∏©‡πå ‡∏≠‡∏±‡∏á‡∏®‡∏ß‡∏≤‡∏Ñ‡∏°</b> ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 3<br>
                <b>3. ‡∏î.‡∏ç.‡∏Å‡∏≤‡∏ô‡∏ï‡∏¥‡πå‡∏ä‡∏ô‡∏¥‡∏ï ‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå</b> ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 14<br>
                <b>4. ‡∏î.‡∏ç.‡∏ä‡∏ô‡∏¥‡∏™‡∏£‡∏≤ ‡∏ä‡∏∞‡πÄ‡∏≠‡∏°</b> ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 15<br>
                <b>5. ‡∏î.‡∏ç.‡∏ß‡∏¥‡∏†‡∏≤‡∏î‡∏≤ ‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏à‡∏£‡∏¥‡∏ç</b> ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 26
            </div>
            <button class="btn btn-primary" onclick="changeLayer('layer-lock')">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>
    </div>

    <div id="layer-lock" class="page-layer">
        <div class="card">
            <h2>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h2>
            <div id="lock-content"><input type="text" id="p-name" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" oninput="checkInputName()"><button id="btn-ready" class="btn btn-primary" onclick="registerPlayer()" disabled>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°</button></div>
            <div id="ready-status" class="hidden"><h3>‚è≥ ‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°...</h3></div>
        </div>
    </div>

    <div id="layer-admin-panel" class="page-layer">
        <div class="card">
            <h3>‚öôÔ∏è Admin Panel</h3>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button class="btn btn-primary btn-sm" style="flex:1" onclick="startGame('MATH')">‡∏™‡∏°‡∏Å‡∏≤‡∏£</button>
                <button class="btn btn-primary btn-sm" style="flex:1; background:#9F7AEA" onclick="startGame('SUDOKU')">Sudoku</button>
                <button class="btn btn-warning btn-sm" style="flex:1" onclick="startGame('GAME24')">Game 24</button>
            </div>
            <button class="btn btn-outline" onclick="loadBanList(); changeLayer('layer-ban-list')">üö´ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô / ‡∏™‡πà‡∏á‡πÄ‡∏â‡∏•‡∏¢</button>
            <button class="btn btn-outline" onclick="changeLayer('layer-scoreboard')">üèÜ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
            <button class="btn btn-outline" onclick="changeLayer('layer-lock')">‡∏Å‡∏•‡∏±‡∏ö</button>
        </div>
    </div>

    <div id="layer-ban-list" class="page-layer">
        <div class="card"><h3>üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h3><div id="ban-table-body" style="max-height:350px; overflow-y:auto; text-align:left;"></div><button class="btn btn-outline" onclick="changeLayer('layer-admin-panel')">‡∏Å‡∏•‡∏±‡∏ö</button></div>
    </div>

    <div id="layer-scoreboard" class="page-layer">
        <div class="card">
            <h2 style="margin:0;">üèÜ Top 5 Leaderboard</h2>
            <p style="font-size:0.8rem; color:var(--primary);">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</p>
            <table id="score-table-body"></table>
            <div id="admin-only-back" class="hidden"><button class="btn btn-outline" onclick="changeLayer('layer-admin-panel')">‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</button></div>
        </div>
    </div>

    <div id="layer-banned" class="page-layer" style="background:#FF0000;">
        <div class="card banned-active">
            <h1 style="color:red; font-size:4rem; margin:0;">‚õî</h1>
            <h2 style="color:red;">‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°</h2>
            <p style="font-size:1.1rem;"><b>‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤</b></p>
        </div>
    </div>

    <div id="layer-hint" class="page-layer" style="background:rgba(255,255,255,0.95);">
        <div class="card">
            <div class="hint-icon">üí°</div>
            <h2 style="color:#F6C90E;">‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤</h2>
            <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô...</p>
        </div>
    </div>

    <div id="layer-unlocking" class="page-layer" style="background:var(--primary);"><div class="unlock-symbol">üîì</div></div>
    <div id="layer-deleted" class="page-layer" style="background:black; color:white;"><h1>üëã ‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á</h1><button class="btn btn-primary" onclick="location.reload()">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</button></div>
    <div id="layer-countdown" class="page-layer" style="background:white;"><div class="card"><h2>READY...</h2><div id="cd-number" style="font-size:6rem; font-weight:800; color:var(--primary);">5</div></div></div>

    <div id="layer-game-math" class="page-layer"><div class="card"><h3>üßÆ ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏°‡∏Å‡∏≤‡∏£</h3><div id="math-display" style="font-size:2.5rem; margin:20px; color:var(--primary); letter-spacing:5px;">_ _ _ _</div><p>‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</p><button class="btn btn-primary" onclick="finishGame()">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button></div></div>

    <div id="layer-admin-auth" class="page-layer" style="background:rgba(0,0,0,0.8);"><div class="card"><h3>üîê Admin Access</h3><input type="password" id="admin-pass-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"><button class="btn btn-primary" onclick="checkAdminPass()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button></div></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDJf-qOOB_hmP1higooEpMSFe2768dMxfE", databaseURL: "https://mathpasswordgame2-default-rtdb.asia-southeast1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myName = "", currentLayer = "layer-welcome", isBanned = false, lastLayerBeforeBan = "layer-lock";
        let scoreInterval = null;

        function changeLayer(id) {
            if(['layer-banned', 'layer-hint', 'layer-unlocking'].includes(id)) {
                document.querySelectorAll('.page-layer').forEach(l => l.classList.remove('active-layer'));
                document.getElementById(id).classList.add('active-layer');
                return;
            }
            lastLayerBeforeBan = id;
            document.querySelectorAll('.page-layer').forEach(l => l.classList.remove('active-layer'));
            document.getElementById(id).classList.add('active-layer');
            
            if(id === 'layer-scoreboard') {
                if(!scoreInterval) scoreInterval = setInterval(updateLeaderboard, 1000);
                document.getElementById('admin-only-back').className = (myName === 'admin') ? '' : 'hidden';
            } else { clearInterval(scoreInterval); scoreInterval = null; }
        }

        function playBannedSound() {
            try {
                const context = new (window.AudioContext || window.webkitAudioContext)();
                const osc = context.createOscillator();
                const gain = context.createGain();
                osc.type = 'square'; osc.frequency.setValueAtTime(880, context.currentTime);
                osc.connect(gain); gain.connect(context.destination);
                osc.start(); gain.gain.exponentialRampToValueAtTime(0.0001, context.currentTime + 5);
                setTimeout(() => osc.stop(), 5000);
            } catch(e) {}
        }

        function registerPlayer() {
            myName = document.getElementById('p-name').value.trim();
            db.ref('players/' + myName).update({ name: myName, status: 'ready', banned: false, hint_trigger: 0 });
            
            db.ref('players/' + myName).on('value', s => {
                const p = s.val(); if(!p) { changeLayer('layer-deleted'); return; }

                // ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ö‡∏ô
                if(p.banned && !isBanned) { isBanned = true; playBannedSound(); changeLayer('layer-banned'); }
                else if(!p.banned && isBanned) { 
                    isBanned = false; changeLayer('layer-unlocking'); 
                    setTimeout(() => changeLayer(lastLayerBeforeBan), 1200); 
                }

                // ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏â‡∏•‡∏¢ (Hint)
                if(p.hint_trigger && (Date.now() - p.hint_trigger < 3000)) {
                    db.ref('players/' + myName).update({ hint_trigger: 0 });
                    changeLayer('layer-hint');
                    setTimeout(finishGame, 2000);
                }

                if(p.status === 'finished' && lastLayerBeforeBan !== 'layer-scoreboard') changeLayer('layer-scoreboard');
            });
            document.getElementById('lock-content').classList.add('hidden');
            document.getElementById('ready-status').classList.remove('hidden');
        }

        function loadBanList() {
            db.ref('players').on('value', s => {
                const con = document.getElementById('ban-table-body'); con.innerHTML = "";
                s.forEach(c => {
                    if(c.key === 'admin') return;
                    const p = c.val();
                    con.innerHTML += `<div style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid #eee;">
                        <span><b>${p.name}</b></span>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-sm btn-warning" onclick="sendHint('${p.name}')">‚ö° ‡πÄ‡∏â‡∏•‡∏¢</button>
                            <button class="btn-sm" style="background:${p.banned?'#00D2BE':'#FF6B6B'}; color:white;" onclick="toggleBan('${p.name}', ${p.banned})">${p.banned?'‡∏õ‡∏•‡∏î':'‡πÅ‡∏ö‡∏ô'}</button>
                            <button class="btn-sm" style="background:black; color:white;" onclick="deletePlayer('${p.name}')">‡∏•‡∏ö</button>
                        </div>
                    </div>`;
                });
            });
        }

        function toggleBan(t, s) { db.ref('players/' + t).update({ banned: !s }); }
        function deletePlayer(t) { if(confirm('‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô '+t+'?')) db.ref('players/'+t).remove(); }
        function sendHint(t) { db.ref('players/' + t).update({ hint_trigger: Date.now() }); }

        function startGame(type) { 
            db.ref('players').once('value', s => {
                s.forEach(c => { if(c.key !== 'admin') db.ref('players/'+c.key).update({status:'ready', finishTime:0, startTime:0}); });
            });
            db.ref('system/game_state').set({ type, state: 'COUNTDOWN', ts: Date.now() }); 
        }

        db.ref('system/game_state').on('value', s => {
            const d = s.val(); if(!d || !myName || Date.now()-d.ts > 10000) return;
            if(d.state === 'COUNTDOWN') {
                changeLayer('layer-countdown'); let c=5;
                let t = setInterval(() => {
                    c--; document.getElementById('cd-number').innerText=c;
                    if(c<=0) { clearInterval(t); if(myName !== 'admin') db.ref('players/'+myName).update({startTime: Date.now(), status: 'playing'}); changeLayer('layer-game-math'); }
                }, 1000);
            }
        });

        function finishGame() { db.ref('players/'+myName).update({finishTime: Date.now(), status: 'finished'}); changeLayer('layer-scoreboard'); }

        function updateLeaderboard() {
            db.ref('players').once('value', s => {
                let pList = [];
                s.forEach(c => { if(c.key !== 'admin' && c.val().finishTime) pList.push({name: c.key, time: (c.val().finishTime - c.val().startTime)/1000}); });
                pList.sort((a,b) => a.time - b.time);
                let h = `<tr><th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th></tr>`;
                pList.slice(0,5).forEach((p, i) => h += `<tr><td><span class="rank-badge">${i+1}</span></td><td><b>${p.name}</b></td><td style="color:red; font-weight:800;">${p.time.toFixed(2)}s</td></tr>`);
                document.getElementById('score-table-body').innerHTML = h || "<tr><td colspan='3'>‡∏£‡∏≠‡∏ô‡∏±‡∏Å‡πÅ‡∏Ç‡πà‡∏á...</td></tr>";
            });
        }

        function openAdminAuth() { changeLayer('layer-admin-auth'); }
        function checkAdminPass() { if(document.getElementById('admin-pass-input').value === "182137") { myName="admin"; changeLayer('layer-admin-panel'); } }
        function checkInputName() { document.getElementById('btn-ready').disabled = document.getElementById('p-name').value.length < 2; }
    </script>
</body>
</html>
