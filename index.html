<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GAME CENTER - COMPLETE SYSTEM</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00D2BE; --secondary: #FFD93D; --accent: #FF6B6B; --bg: #F0F4F8; --card-bg: #FFFFFF; --text: #2D3436; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Kanit', sans-serif; margin: 0; background: var(--bg); color: var(--text); height: 100vh; width: 100vw; overflow: hidden; }
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∏‡∏ö */
        .btn, .btn-sm, .key { transition: transform 0.1s; cursor: pointer; }
        .btn:active, .btn-sm:active, .key:active { transform: scale(0.9); filter: brightness(0.9); }
        
        .page-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; align-items: center; justify-content: center; padding: 20px; z-index: 10; }
        .active-layer { display: flex !important; z-index: 100 !important; }
        .card { background: var(--card-bg); padding: 25px; border-radius: 25px; width: 100%; max-width: 440px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); text-align: center; max-height: 90vh; overflow-y: auto; }
        
        .btn { display: block; width: 100%; padding: 14px; border-radius: 15px; border: none; font-family: 'Kanit'; font-weight: 600; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: #F1F3F5; color: #4A5568; }

        /* ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Å‡∏° & ‡πÅ‡∏õ‡πâ‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå */
        .math-box { font-size: 1.2rem; background: #f0fdfa; padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 2px dashed var(--primary); }
        .code-display { font-size: 2.5rem; font-weight: 800; color: var(--primary); letter-spacing: 10px; margin: 15px 0; height: 50px; }
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .key { background: white; border: 2px solid #edf2f7; padding: 15px; border-radius: 15px; font-size: 1.5rem; font-weight: 600; box-shadow: 0 4px 0 #edf2f7; }
        .key-del { background: #fee2e2; color: #ef4444; border-color: #fecaca; box-shadow: 0 4px 0 #fecaca; }

        /* ‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô */
        #layer-banned { background: #FF0000 !important; z-index: 9999 !important; }
        .banned-shake { animation: shake 0.3s infinite; }
        @keyframes shake { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(-5px,0); } 75% { transform: translate(5px,0); } }
        #layer-unlocking { background: var(--primary) !important; z-index: 10000 !important; }
        .unlock-anim { font-size: 100px; animation: fly 1.2s forwards; color: white; }
        @keyframes fly { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.5); opacity: 1; } 100% { transform: scale(5); opacity: 0; } }

        .lobby-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .status-dot { width: 10px; height: 10px; background: var(--primary); border-radius: 50%; }
    </style>
</head>
<body>

    <div id="layer-welcome" class="page-layer active-layer"><div class="card"><h1 style="color:var(--primary); font-size: 2.5rem;">MATH CODE</h1><button class="btn btn-primary" onclick="changeLayer('layer-intro')">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button></div></div>
    
    <div id="layer-intro" class="page-layer">
        <div class="card">
            <h2>üë• ‡∏Ñ‡∏ì‡∏∞‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥</h2>
            <div style="text-align:left; font-size:0.9rem; line-height:1.7; margin: 15px 0; background:#f8fafc; padding:15px; border-radius:15px;">
                1. ‡∏î.‡∏ä.‡∏ä‡∏±‡∏¢‡πÄ‡∏°‡∏ò ‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏≠‡∏°‡∏£‡πÄ‡∏ß‡∏ä ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 2<br>
                2. ‡∏î.‡∏ä.‡∏ì‡∏±‡∏ê‡∏û‡∏á‡∏©‡πå ‡∏≠‡∏±‡∏á‡∏®‡∏ß‡∏≤‡∏Ñ‡∏° ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 3<br>
                3. ‡∏î.‡∏ç.‡∏Å‡∏≤‡∏ô‡∏ï‡∏¥‡πå‡∏ä‡∏ô‡∏¥‡∏ï ‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 14<br>
                4. ‡∏î.‡∏ç.‡∏ä‡∏ô‡∏¥‡∏™‡∏£‡∏≤ ‡∏ä‡∏∞‡πÄ‡∏≠‡∏° ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 15<br>
                5. ‡∏î.‡∏ç.‡∏ß‡∏¥‡∏†‡∏≤‡∏î‡∏≤ ‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏à‡∏£‡∏¥‡∏ç ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 26
            </div>
            <button class="btn btn-primary" onclick="changeLayer('layer-lock')">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>
    </div>

    <div id="layer-lock" class="page-layer">
        <div class="card">
            <h2>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h2>
            <input type="text" id="p-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" oninput="checkInputName()">
            <button id="btn-ready" class="btn btn-primary" onclick="registerPlayer()" disabled>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°</button>
        </div>
    </div>

    <div id="layer-lobby" class="page-layer">
        <div class="card">
            <h3>‚è≥ ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h3>
            <div id="lobby-list" style="margin: 15px 0; max-height: 250px; overflow-y: auto;"></div>
            <p style="font-size:0.8rem; color:gray;">‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ï‡∏±‡∏ß...</p>
        </div>
    </div>

    <div id="layer-game-math" class="page-layer">
        <div class="card">
            <div class="math-box">
                <b>‡πÇ‡∏à‡∏ó‡∏¢‡πå:</b> 2x + 5 = 13 | 10 - y = 8<br>
                <b>‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏∑‡∏≠ (x)(y) ‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢ 00</b>
            </div>
            <div id="code-input" class="code-display">____</div>
            <div class="keypad">
                <button class="key" onclick="pressKey('1')">1</button>
                <button class="key" onclick="pressKey('2')">2</button>
                <button class="key" onclick="pressKey('3')">3</button>
                <button class="key" onclick="pressKey('4')">4</button>
                <button class="key" onclick="pressKey('5')">5</button>
                <button class="key" onclick="pressKey('6')">6</button>
                <button class="key" onclick="pressKey('7')">7</button>
                <button class="key" onclick="pressKey('8')">8</button>
                <button class="key" onclick="pressKey('9')">9</button>
                <button class="key" style="background:#f1f5f9" disabled></button>
                <button class="key" onclick="pressKey('0')">0</button>
                <button class="key key-del" onclick="pressKey('DEL')">‚å´</button>
            </div>
            <button class="btn btn-primary" style="margin-top:20px" onclick="submitCode()">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
        </div>
    </div>

    <div id="layer-admin-panel" class="page-layer"><div class="card"><h3>‚öôÔ∏è Admin</h3><button class="btn btn-primary" onclick="adminStart()">‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô!</button><button class="btn btn-outline" onclick="loadManageList(); changeLayer('layer-manage')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô/‡πÅ‡∏ö‡∏ô/‡πÄ‡∏â‡∏•‡∏¢</button></div></div>
    <div id="layer-manage" class="page-layer"><div class="card"><h3>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h3><div id="manage-box" style="text-align:left;"></div><button class="btn btn-outline" onclick="changeLayer('layer-admin-panel')">‡∏Å‡∏•‡∏±‡∏ö</button></div></div>
    <div id="layer-scoreboard" class="page-layer"><div class="card"><h2>üèÜ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2><table id="score-table" style="width:100%"></table><button class="btn btn-outline" onclick="location.reload()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button></div></div>
    <div id="layer-banned" class="page-layer"><div class="card banned-shake"><h1 style="color:red;">‚õî</h1><h2>‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2><p>‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤</p></div></div>
    <div id="layer-unlocking" class="page-layer"><div class="unlock-anim">üîì</div></div>
    <div id="layer-hint" class="page-layer" style="background:white;"><div class="card"><div style="font-size:60px; animation: fly 1s infinite;">üí°</div><h2>‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤</h2></div></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDJf-qOOB_hmP1higooEpMSFe2768dMxfE", databaseURL: "https://mathpasswordgame2-default-rtdb.asia-southeast1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myName = "", currentLayer = "layer-welcome", isBanned = false, inputCode = "", lobbyInt = null;

        function changeLayer(id) {
            if(['layer-banned','layer-unlocking','layer-hint'].includes(id)) {
                document.querySelectorAll('.page-layer').forEach(l => l.classList.remove('active-layer'));
                document.getElementById(id).classList.add('active-layer');
                return;
            }
            currentLayer = id;
            document.querySelectorAll('.page-layer').forEach(l => l.classList.remove('active-layer'));
            document.getElementById(id).classList.add('active-layer');
            
            if(id === 'layer-lobby') { if(!lobbyInt) lobbyInt = setInterval(updateLobby, 1000); } 
            else { clearInterval(lobbyInt); lobbyInt = null; }
        }

        // --- ‡πÄ‡∏Å‡∏°‡∏™‡∏°‡∏Å‡∏≤‡∏£ & ‡πÅ‡∏õ‡πâ‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå ---
        function pressKey(num) {
            if(num === 'DEL') { inputCode = inputCode.slice(0, -1); }
            else if(inputCode.length < 4) { inputCode += num; }
            document.getElementById('code-input').innerText = inputCode.padEnd(4, '_');
        }

        function submitCode() {
            if(inputCode === "4200") { // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏∑‡∏≠ 4200
                db.ref('players/'+myName).update({ status: 'finished', finishTime: Date.now() });
                changeLayer('layer-scoreboard');
                updateScore();
            } else { alert("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!"); inputCode = ""; pressKey(''); }
        }

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏° & ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ---
        function registerPlayer() {
            myName = document.getElementById('p-name').value.trim();
            db.ref('players/'+myName).set({ name: myName, status: 'ready', banned: false, hint: false });
            changeLayer('layer-lobby');
            
            db.ref('players/'+myName).on('value', s => {
                const p = s.val(); if(!p) return;
                // ‡πÅ‡∏ö‡∏ô/‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô
                if(p.banned && !isBanned) { isBanned = true; playBeep(); changeLayer('layer-banned'); }
                else if(!p.banned && isBanned) { isBanned = false; changeLayer('layer-unlocking'); setTimeout(()=>changeLayer(currentLayer), 1500); }
                // ‡πÄ‡∏â‡∏•‡∏¢
                if(p.hint) {
                    db.ref('players/'+myName).update({ hint: false, status: 'finished', finishTime: Date.now(), startTime: Date.now()-5000 });
                    changeLayer('layer-hint');
                    setTimeout(()=>changeLayer('layer-scoreboard'), 2500);
                }
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°
                if(p.status === 'playing' && currentLayer !== 'layer-game-math') {
                    inputCode = ""; changeLayer('layer-game-math');
                }
            });
        }

        function updateLobby() {
            db.ref('players').once('value', s => {
                let h = ""; s.forEach(c => { if(c.key !== 'admin') h += `<div class="lobby-item"><span>${c.val().name}</span><div class="status-dot"></div></div>`; });
                document.getElementById('lobby-list').innerHTML = h || "‡∏£‡∏≠‡∏ô‡∏±‡∏Å‡πÅ‡∏Ç‡πà‡∏á...";
            });
        }

        // --- Admin ---
        function adminStart() {
            db.ref('players').once('value', s => {
                s.forEach(c => { if(c.key !== 'admin') db.ref('players/'+c.key).update({ status: 'playing', startTime: Date.now() }); });
            });
        }

        function loadManageList() {
            db.ref('players').on('value', s => {
                let h = ""; s.forEach(c => { if(c.key === 'admin') return; let p = c.val();
                    h += `<div style="margin-bottom:10px; display:flex; justify-content:space-between;">
                        <b>${p.name}</b>
                        <div>
                            <button class="btn-sm" style="background:#FFD93D;" onclick="db.ref('players/${p.name}').update({hint:true})">‚ö°</button>
                            <button class="btn-sm" style="background:${p.banned?'#00D2BE':'#FF6B6B'}; color:white;" onclick="db.ref('players/${p.name}').update({banned:!${p.banned}})">${p.banned?'‡∏õ‡∏•‡∏î':'‡πÅ‡∏ö‡∏ô'}</button>
                            <button class="btn-sm" style="background:black; color:white;" onclick="db.ref('players/${p.name}').remove()">‡∏•‡∏ö</button>
                        </div>
                    </div>`;
                });
                document.getElementById('manage-box').innerHTML = h;
            });
        }

        function updateScore() {
            db.ref('players').once('value', s => {
                let list = []; s.forEach(c => { if(c.val().finishTime) list.push(c.val()); });
                list.sort((a,b) => (a.finishTime-a.startTime) - (b.finishTime-b.startTime));
                let h = "<tr><th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th></tr>";
                list.forEach((p,i) => h += `<tr><td>${i+1}</td><td>${p.name}</td><td>${((p.finishTime-p.startTime)/1000).toFixed(2)}s</td></tr>`);
                document.getElementById('score-table').innerHTML = h;
            });
        }

        function playBeep() { let ctx = new (window.AudioContext || window.webkitAudioContext)(); let osc = ctx.createOscillator(); let gain = ctx.createGain(); osc.type = 'square'; osc.frequency.setValueAtTime(800, ctx.currentTime); osc.connect(gain); gain.connect(ctx.destination); osc.start(); gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 5); setTimeout(()=>osc.stop(), 5000); }
        function checkInputName() { document.getElementById('btn-ready').disabled = document.getElementById('p-name').value.length < 2; }
        function openAdminAuth() { if(prompt("Pass:") === "182137") { myName="admin"; changeLayer('layer-admin-panel'); } }
    </script>
</body>
</html>
