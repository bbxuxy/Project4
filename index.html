<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GAME CENTER - FULL SYSTEM</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00D2BE; --secondary: #FFD93D; --accent: #FF6B6B; --bg: #F0F4F8; --card-bg: #FFFFFF; --text: #2D3436; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Kanit', sans-serif; margin: 0; background: var(--bg); color: var(--text); height: 100vh; width: 100vw; overflow: hidden; }
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∏‡∏ö */
        .btn, .btn-sm { transition: transform 0.1s; cursor: pointer; }
        .btn:active, .btn-sm:active { transform: scale(0.92); }
        
        .page-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; align-items: center; justify-content: center; padding: 20px; z-index: 10; }
        .active-layer { display: flex !important; z-index: 100 !important; }
        .card { background: var(--card-bg); padding: 25px; border-radius: 25px; width: 100%; max-width: 440px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); text-align: center; max-height: 90vh; overflow-y: auto; }
        
        .btn { display: block; width: 100%; padding: 14px; border-radius: 15px; border: none; font-family: 'Kanit'; font-weight: 600; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: #F1F3F5; color: #4A5568; }
        .btn-sm { padding: 6px 12px; border-radius: 8px; border: none; font-family: 'Kanit'; }

        /* ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ö‡∏ô & ‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô */
        #layer-banned { background: #FF0000 !important; z-index: 9999 !important; }
        .banned-shake { animation: shake 0.3s infinite; border: 5px solid red; }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-2px, -1px); } 100% { transform: translate(1px, 1px); } }
        
        #layer-unlocking { background: var(--primary) !important; z-index: 10000 !important; }
        .unlock-anim { font-size: 100px; animation: unlockFly 1.2s forwards; color: white; }
        @keyframes unlockFly { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.5); opacity: 1; } 100% { transform: scale(4); opacity: 0; } }

        /* ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏° (Lobby) */
        .lobby-list { text-align: left; background: #f9f9f9; padding: 15px; border-radius: 15px; margin: 15px 0; max-height: 200px; overflow-y: auto; }
        .lobby-item { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .status-dot { height: 10px; width: 10px; background-color: #00D2BE; border-radius: 50%; display: inline-block; }
    </style>
</head>
<body>

    <div style="position:fixed; top:15px; right:15px; z-index:1001; font-size:24px;" onclick="openAdminAuth()">‚öôÔ∏è</div>

    <div id="layer-welcome" class="page-layer active-layer"><div class="card"><h1>GAME CENTER</h1><button class="btn btn-primary" onclick="changeLayer('layer-intro')">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button></div></div>
    
    <div id="layer-intro" class="page-layer">
        <div class="card">
            <h2>üë• ‡∏Ñ‡∏ì‡∏∞‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥</h2>
            <div style="text-align:left; font-size:0.9rem; line-height:1.6; margin-bottom:15px;">
                1. ‡∏î.‡∏ä.‡∏ä‡∏±‡∏¢‡πÄ‡∏°‡∏ò ‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏≠‡∏°‡∏£‡πÄ‡∏ß‡∏ä ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 2<br>
                2. ‡∏î.‡∏ä.‡∏ì‡∏±‡∏ê‡∏û‡∏á‡∏©‡πå ‡∏≠‡∏±‡∏á‡∏®‡∏ß‡∏≤‡∏Ñ‡∏° ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 3<br>
                3. ‡∏î.‡∏ç.‡∏Å‡∏≤‡∏ô‡∏ï‡∏¥‡πå‡∏ä‡∏ô‡∏¥‡∏ï ‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 14<br>
                4. ‡∏î.‡∏ç.‡∏ä‡∏ô‡∏¥‡∏™‡∏£‡∏≤ ‡∏ä‡∏∞‡πÄ‡∏≠‡∏° ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 15<br>
                5. ‡∏î.‡∏ç.‡∏ß‡∏¥‡∏†‡∏≤‡∏î‡∏≤ ‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏à‡∏£‡∏¥‡∏ç ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 26
            </div>
            <button class="btn btn-primary" onclick="changeLayer('layer-lock')">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>
    </div>

    <div id="layer-lock" class="page-layer">
        <div class="card">
            <h2>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h2>
            <input type="text" id="p-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" oninput="checkInputName()">
            <button id="btn-ready" class="btn btn-primary" onclick="registerPlayer()" disabled>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°</button>
        </div>
    </div>

    <div id="layer-lobby" class="page-layer">
        <div class="card">
            <h3>‚è≥ ‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô...</h3>
            <div class="lobby-list" id="lobby-players-box"></div>
            <p style="font-size:0.8rem; color:gray;">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</p>
        </div>
    </div>

    <div id="layer-admin-panel" class="page-layer">
        <div class="card">
            <h3>‚öôÔ∏è ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</h3>
            <button class="btn btn-primary" onclick="startGame('MATH')">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°!</button>
            <button class="btn btn-outline" onclick="loadBanList(); changeLayer('layer-admin-manage')">üö´ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button>
            <button class="btn btn-outline" onclick="changeLayer('layer-scoreboard')">üèÜ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
            <button class="btn btn-outline" onclick="changeLayer('layer-welcome')">‡∏≠‡∏≠‡∏Å</button>
        </div>
    </div>

    <div id="layer-admin-manage" class="page-layer">
        <div class="card">
            <h3>üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
            <div id="manage-table-body" style="text-align:left;"></div>
            <button class="btn btn-outline" onclick="changeLayer('layer-admin-panel')">‡∏Å‡∏•‡∏±‡∏ö</button>
        </div>
    </div>

    <div id="layer-scoreboard" class="page-layer">
        <div class="card">
            <h2>üèÜ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</h2>
            <table id="score-table" style="width:100%"></table>
            <button id="admin-back-btn" class="btn btn-outline hidden" onclick="changeLayer('layer-admin-panel')">‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</button>
        </div>
    </div>

    <div id="layer-banned" class="page-layer"><div class="card banned-shake"><h1 style="color:red;">‚õî</h1><h2>‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°</h2><p>‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤</p></div></div>
    <div id="layer-unlocking" class="page-layer"><div class="unlock-anim">üîì</div></div>
    <div id="layer-hint" class="page-layer" style="background:white;"><div class="card"><div style="font-size:50px;">üí°</div><h2>‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤</h2></div></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDJf-qOOB_hmP1higooEpMSFe2768dMxfE", databaseURL: "https://mathpasswordgame2-default-rtdb.asia-southeast1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myName = "", currentLayer = "layer-welcome", isBanned = false, lobbyInterval = null;

        function changeLayer(id) {
            if(['layer-banned', 'layer-unlocking', 'layer-hint'].includes(id)) {
                document.querySelectorAll('.page-layer').forEach(l => l.classList.remove('active-layer'));
                document.getElementById(id).classList.add('active-layer');
                return;
            }
            currentLayer = id;
            document.querySelectorAll('.page-layer').forEach(l => l.classList.remove('active-layer'));
            document.getElementById(id).classList.add('active-layer');

            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Loop ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
            if(id === 'layer-lobby') { if(!lobbyInterval) lobbyInterval = setInterval(updateLobby, 1000); } 
            else { clearInterval(lobbyInterval); lobbyInterval = null; }
            
            if(id === 'layer-scoreboard') {
                updateScoreboard();
                if(myName === 'admin') document.getElementById('admin-back-btn').classList.remove('hidden');
            }
        }

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏° & Lobby ---
        function registerPlayer() {
            myName = document.getElementById('p-name').value.trim();
            db.ref('players/' + myName).set({ name: myName, status: 'ready', banned: false, hint: false });
            changeLayer('layer-lobby');
            listenStatus();
        }

        function updateLobby() {
            db.ref('players').once('value', s => {
                let html = "";
                s.forEach(c => {
                    if(c.key !== 'admin') {
                        html += `<div class="lobby-item"><span>${c.val().name}</span> <span class="status-dot"></span></div>`;
                    }
                });
                document.getElementById('lobby-players-box').innerHTML = html || "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå...";
            });
        }

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ö‡∏ô & ‡∏õ‡∏•‡∏î‡πÅ‡∏ö‡∏ô (Fixed) ---
        function listenStatus() {
            db.ref('players/' + myName).on('value', s => {
                const p = s.val();
                if(!p) { location.reload(); return; } // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏î‡∏ô‡∏•‡∏ö‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ö‡∏ô
                if(p.banned && !isBanned) {
                    isBanned = true;
                    playBeep();
                    changeLayer('layer-banned');
                } else if(!p.banned && isBanned) {
                    isBanned = false;
                    changeLayer('layer-unlocking');
                    setTimeout(() => changeLayer(currentLayer), 1500);
                }

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏â‡∏•‡∏¢
                if(p.hint) {
                    db.ref('players/' + myName).update({ hint: false, status: 'finished', finishTime: Date.now() });
                    changeLayer('layer-hint');
                    setTimeout(() => changeLayer('layer-scoreboard'), 2000);
                }

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
                if(p.status === 'playing') {
                    document.body.innerHTML = "<h1>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Å‡∏°... (‡πÉ‡∏™‡πà‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)</h1>";
                }
            });
        }

        function playBeep() {
            let ctx = new (window.AudioContext || window.webkitAudioContext)();
            let osc = ctx.createOscillator();
            let gain = ctx.createGain();
            osc.type = 'square'; osc.frequency.setValueAtTime(800, ctx.currentTime);
            osc.connect(gain); gain.connect(ctx.destination);
            osc.start(); gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 5);
            setTimeout(() => osc.stop(), 5000);
        }

        // --- Admin Logic ---
        function loadBanList() {
            db.ref('players').on('value', s => {
                let html = "";
                s.forEach(c => {
                    if(c.key === 'admin') return;
                    let p = c.val();
                    html += `<div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                        <b>${p.name}</b>
                        <div>
                            <button class="btn-sm" style="background:#FFD93D;" onclick="db.ref('players/${p.name}').update({hint:true})">‚ö°</button>
                            <button class="btn-sm" style="background:${p.banned?'#00D2BE':'#FF6B6B'}; color:white;" onclick="db.ref('players/${p.name}').update({banned:!${p.banned}})">
                                ${p.banned?'‡∏õ‡∏•‡∏î':'‡πÅ‡∏ö‡∏ô'}
                            </button>
                            <button class="btn-sm" style="background:black; color:white;" onclick="db.ref('players/${p.name}').remove()">‡∏•‡∏ö</button>
                        </div>
                    </div>`;
                });
                document.getElementById('manage-table-body').innerHTML = html;
            });
        }

        function startGame() {
            db.ref('players').once('value', s => {
                s.forEach(c => { if(c.key !== 'admin') db.ref('players/'+c.key).update({status:'playing', startTime: Date.now()}); });
            });
        }

        function updateScoreboard() {
            db.ref('players').once('value', s => {
                let list = [];
                s.forEach(c => { if(c.val().finishTime) list.push(c.val()); });
                list.sort((a,b) => (a.finishTime-a.startTime) - (b.finishTime-b.startTime));
                let h = "<tr><th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th></tr>";
                list.forEach((p,i) => { h += `<tr><td>${i+1}</td><td>${p.name}</td><td>${((p.finishTime-p.startTime)/1000).toFixed(2)}s</td></tr>`; });
                document.getElementById('score-table').innerHTML = h;
            });
        }

        function checkInputName() { document.getElementById('btn-ready').disabled = document.getElementById('p-name').value.length < 2; }
        function openAdminAuth() { let p = prompt("Admin Password:"); if(p === "182137") { myName="admin"; changeLayer('layer-admin-panel'); } }
    </script>
</body>
</html>
